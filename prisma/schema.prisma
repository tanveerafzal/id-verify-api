generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String?   @unique
  password      String
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([username])
  @@index([email])
}

model Partner {
  id                String          @id @default(uuid())
  email             String          @unique
  password          String
  companyName       String
  contactName       String
  phone             String?

  // Tier Management
  tierId            String
  tier              Tier            @relation(fields: [tierId], references: [id])

  // API Credentials
  apiKey            String          @unique @default(uuid())
  apiSecret         String          @default(uuid())

  // Usage Tracking
  verificationsUsed Int             @default(0)
  verifications     Verification[]  @relation("PartnerVerifications")

  // Status
  isActive          Boolean         @default(true)

  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([email])
  @@index([apiKey])
  @@index([tierId])
}

model Tier {
  id                    String    @id @default(uuid())
  name                  String    @unique
  displayName           String
  monthlyPrice          Float
  yearlyPrice           Float

  // Limits
  monthlyVerifications  Int
  apiCallsPerMinute     Int       @default(10)

  // Features
  features              Json

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  partners              Partner[]

  @@index([name])
}

model Verification {
  id                String            @id @default(uuid())
  userId            String?
  partnerId         String?
  partner           Partner?          @relation("PartnerVerifications", fields: [partnerId], references: [id])
  status            VerificationStatus @default(PENDING)
  type              VerificationType
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  completedAt       DateTime?

  // Document Information
  documents         Document[]

  // Verification Results
  results           VerificationResult?

  // Metadata
  metadata          Json?
  ipAddress         String?
  userAgent         String?

  // Webhook
  webhookUrl        String?
  webhookEvents     WebhookEvent[]

  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
}

model Document {
  id                String          @id @default(uuid())
  verificationId    String
  verification      Verification    @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  type              DocumentType
  side              DocumentSide?

  // File Information
  originalUrl       String
  processedUrl      String?
  thumbnailUrl      String?

  // Extracted Data
  extractedData     Json?

  // Quality Checks
  qualityScore      Float?
  isBlurry          Boolean         @default(false)
  hasGlare          Boolean         @default(false)
  isComplete        Boolean         @default(true)

  // OCR Results
  ocrText           String?
  ocrConfidence     Float?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([verificationId])
  @@index([type])
}

model VerificationResult {
  id                String          @id @default(uuid())
  verificationId    String          @unique
  verification      Verification    @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  // Overall Result
  passed            Boolean         @default(false)
  score             Float?
  riskLevel         RiskLevel       @default(MEDIUM)

  // Identity Checks
  nameMatch         Boolean?
  dateOfBirthMatch  Boolean?
  addressMatch      Boolean?

  // Document Checks
  documentAuthentic Boolean?
  documentExpired   Boolean?
  documentTampered  Boolean?

  // Biometric Checks
  faceMatch         Boolean?
  faceMatchScore    Float?
  livenessCheck     Boolean?
  livenessScore     Float?

  // Extracted Information
  extractedName     String?
  extractedDob      DateTime?
  extractedAddress  String?
  documentNumber    String?
  issuingCountry    String?
  expiryDate        DateTime?

  // Flags and Warnings
  flags             String[]
  warnings          String[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model WebhookEvent {
  id                String          @id @default(uuid())
  verificationId    String
  verification      Verification    @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  eventType         String
  payload           Json

  // Delivery Information
  delivered         Boolean         @default(false)
  deliveryAttempts  Int             @default(0)
  lastAttemptAt     DateTime?
  deliveredAt       DateTime?

  // Response
  responseStatus    Int?
  responseBody      String?

  createdAt         DateTime        @default(now())

  @@index([verificationId])
  @@index([delivered])
  @@index([createdAt])
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  REQUIRES_INPUT
  COMPLETED
  FAILED
  EXPIRED
}

enum VerificationType {
  IDENTITY
  DOCUMENT_ONLY
  SELFIE_ONLY
  FULL_KYC
}

enum DocumentType {
  DRIVERS_LICENSE
  PASSPORT
  NATIONAL_ID
  RESIDENCE_PERMIT
  VOTER_ID
  OTHER
}

enum DocumentSide {
  FRONT
  BACK
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum UserRole {
  ADMIN
  USER
  API_CLIENT
}

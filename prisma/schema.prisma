generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  fullName      String?
  phone         String?
  verifications Verification[] @relation("UserVerifications")

  @@index([email])
}

model Partner {
  id                String         @id @default(uuid())
  email             String         @unique
  password          String
  companyName       String
  contactName       String
  phone             String?
  tierId            String
  apiKey            String         @unique @default(uuid())
  apiSecret         String         @default(uuid())
  verificationsUsed Int            @default(0)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  address           String?
  logoUrl           String?
  website           String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  tier              Tier           @relation(fields: [tierId], references: [id])
  verifications     Verification[] @relation("PartnerVerifications")

  @@index([email])
  @@index([apiKey])
  @@index([tierId])
}

model Tier {
  id                   String    @id @default(uuid())
  name                 String    @unique
  displayName          String
  monthlyPrice         Float
  yearlyPrice          Float
  monthlyVerifications Int
  apiCallsPerMinute    Int       @default(10)
  features             Json
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  partners             Partner[]

  @@index([name])
}

model Verification {
  id            String              @id @default(uuid())
  userId        String?
  status        VerificationStatus  @default(PENDING)
  type          VerificationType
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  completedAt   DateTime?
  metadata      Json?
  ipAddress     String?
  userAgent     String?
  webhookUrl    String?
  partnerId     String?
  maxRetries    Int                 @default(5)
  retryCount    Int                 @default(0)
  documents     Document[]
  partner       Partner?            @relation("PartnerVerifications", fields: [partnerId], references: [id])
  user          User?               @relation("UserVerifications", fields: [userId], references: [id])
  results       VerificationResult?
  webhookEvents WebhookEvent[]

  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@index([createdAt])
}

model Document {
  id             String        @id @default(uuid())
  verificationId String
  type           DocumentType
  side           DocumentSide?
  originalUrl    String
  processedUrl   String?
  thumbnailUrl   String?
  extractedData  Json?
  qualityScore   Float?
  isBlurry       Boolean       @default(false)
  hasGlare       Boolean       @default(false)
  isComplete     Boolean       @default(true)
  ocrText        String?
  ocrConfidence  Float?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  verification   Verification  @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId])
  @@index([type])
}

model VerificationResult {
  id                String       @id @default(uuid())
  verificationId    String       @unique
  passed            Boolean      @default(false)
  score             Float?
  riskLevel         RiskLevel    @default(MEDIUM)
  nameMatch         Boolean?
  dateOfBirthMatch  Boolean?
  addressMatch      Boolean?
  documentAuthentic Boolean?
  documentExpired   Boolean?
  documentTampered  Boolean?
  faceMatch         Boolean?
  faceMatchScore    Float?
  livenessCheck     Boolean?
  livenessScore     Float?
  extractedName     String?
  extractedDob      DateTime?
  extractedAddress  String?
  documentNumber    String?
  issuingCountry    String?
  expiryDate        DateTime?
  flags             String[]
  warnings          String[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  extractedData     Json?
  verification      Verification @relation(fields: [verificationId], references: [id], onDelete: Cascade)
}

model WebhookEvent {
  id               String       @id @default(uuid())
  verificationId   String
  eventType        String
  payload          Json
  delivered        Boolean      @default(false)
  deliveryAttempts Int          @default(0)
  lastAttemptAt    DateTime?
  deliveredAt      DateTime?
  responseStatus   Int?
  responseBody     String?
  createdAt        DateTime     @default(now())
  verification     Verification @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId])
  @@index([delivered])
  @@index([createdAt])
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  REQUIRES_INPUT
  COMPLETED
  FAILED
  EXPIRED
}

enum VerificationType {
  IDENTITY
  DOCUMENT_ONLY
  SELFIE_ONLY
  FULL_KYC
}

enum DocumentType {
  DRIVERS_LICENSE
  PASSPORT
  NATIONAL_ID
  RESIDENCE_PERMIT
  PERMANENT_RESIDENT_CARD
  VOTER_ID
  SELFIE
  OTHER
}

enum DocumentSide {
  FRONT
  BACK
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Admin {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  role      AdminRole @default(ADMIN)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([email])
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}
